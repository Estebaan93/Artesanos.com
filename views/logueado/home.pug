//-views/logueado/home.pug
extends ../layouts/logueado

block headExtra 
  link(rel="stylesheet", href="/css/explorerPublico.css")

block content
  //- SECCIÓN EVENTOS
  if eventos && eventos.length
    h2 Eventos destacados
    ul.eventos-lista
      each evento in eventos
        li.evento-item
          h3= evento.titulo
          p= evento.descripcion
          if evento.fecha
            p Fecha: #{evento.fecha}
  else
    p.mensaje-alerta No hay eventos para mostrar.

  //- SECCIÓN ÁLBUMES PÚBLICOS DE USUARIOS
  h2 Álbumes públicos de la comunidad

  if albumesPublicos && albumesPublicos.length
    each album in albumesPublicos
      .album-publico
        h3
          | #{album.titulo} 
          small por 
            a(href=`/portafolio/${album.autor_id}`)= album.autor_nombre + " " + album.autor_apellido
        if !album.imagenes || album.imagenes.length === 0
          p Sin imágenes públicas.
        else
          .imagenes-grid
            each img in album.imagenes
              - const srcImg = img.imagen.startsWith('http') ? img.imagen : `/img/obras/${img.imagen}`
              .img-con-comentarios
                img.imagen-clickable(
                  src=srcImg,
                  alt=img.titulo,
                  data-usuario=`${album.autor_nombre} ${album.autor_apellido}`,
                  data-titulo=img.titulo
                )
                //- Comentarios y formulario (solo logueado, ¡y este home es para logueados!)
                if img.comentarios && img.comentarios.length
                  ul.comentarios
                    each com in img.comentarios
                      li
                        strong= com.usuario
                        | : #{com.descripcion}
                //- Formulario para comentar
                form(
                  method="POST",
                  action=`/imagen/${img.id_imagen}/comentario`,
                  class="form-comentar"
                )
                  textarea(name="descripcion" required placeholder="Agregar un comentario…")
                  button(type="submit") Comentar
  else
    p.mensaje-alerta No hay álbumes públicos en este momento.

  script(src="/js/modalImagen.js")
  script.
    document.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll("form.form-comentar").forEach(form => {
        form.addEventListener("submit", async function(e) {
          e.preventDefault();
          const textarea = form.querySelector("textarea[name=descripcion]");
          const descripcion = textarea.value.trim();
          if (!descripcion) return;
          const action = form.action;

          const res = await fetch(action, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: "descripcion=" + encodeURIComponent(descripcion)
          });

          if (res.ok) {
            // Actualizar comentarios (opcional: sacar "Sin comentarios.")
            const ul = form.previousElementSibling;
            if (ul && ul.classList.contains("comentarios")) {
              if (ul.children.length === 1 && ul.children[0].textContent.includes("Sin comentarios")) {
                ul.innerHTML = "";
              }
              // OJO: tu backend solo devuelve ok, si querés nombre del usuario podrías pasarlo desde JS global.
              let usuario = window.usuario?.nombre || "Tú";
              const li = document.createElement("li");
              li.innerHTML = `<strong>${usuario}</strong>: ${descripcion}`;
              ul.prepend(li);
            }
            textarea.value = "";
          } else if (res.status === 401) {
            Swal.fire("Debes estar logueado para comentar");
          } else {
            Swal.fire("No se pudo agregar el comentario");
          }
        });
      });
    });